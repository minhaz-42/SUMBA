{% extends 'base.html' %}

{% block content %}
<!-- Deprecated duplicate capture page: redirecting to canonical gestures capture -->
<script>window.location.href = "{% url 'gesture_capture' %}";</script>
{% endblock %}

    <main class="max-w-7xl mx-auto px-6 py-8">
        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Video & Skeleton Panel -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Camera Feed -->
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                    <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                        <h2 class="text-lg font-semibold">Camera Feed</h2>
                        <div id="status-indicator" class="flex items-center text-sm">
                            <span class="w-2 h-2 rounded-full bg-gray-400 mr-2"></span>
                            <span class="text-gray-600">Disconnected</span>
                        </div>
                    </div>
                    <div class="relative aspect-video bg-gray-900">
                        <video id="video-feed" class="w-full h-full object-cover" autoplay playsinline muted></video>
                        <canvas id="skeleton-overlay" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
                        
                        <!-- Recording Indicator -->
                        <div id="recording-indicator" class="hidden absolute top-4 right-4 flex items-center bg-red-500 text-white px-3 py-1 rounded-full text-sm font-medium recording">
                            <span class="w-2 h-2 bg-white rounded-full mr-2"></span>
                            REC
                        </div>

                        <!-- Frame Counter -->
                        <div class="absolute bottom-4 left-4 bg-black/50 text-white px-3 py-1 rounded-lg text-sm font-mono">
                            Frame: <span id="frame-count">0</span> / 150
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex flex-wrap gap-4 items-center justify-between">
                        <div class="flex gap-3">
                            <button id="btn-connect" class="px-6 py-3 bg-primary text-white font-medium rounded-xl hover:bg-primary-dark transition flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                                Connect Camera
                            </button>
                            <button id="btn-record" disabled class="px-6 py-3 bg-red-500 text-white font-medium rounded-xl hover:bg-red-600 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="8"></circle>
                                </svg>
                                Start Recording
                            </button>
                            <button id="btn-stop" disabled class="px-6 py-3 bg-gray-500 text-white font-medium rounded-xl hover:bg-gray-600 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                                </svg>
                                Stop
                            </button>
                        </div>
                        <div class="flex gap-3">
                            <button id="btn-save" disabled class="flex-1 px-6 py-3 bg-secondary text-white font-medium rounded-xl hover:bg-green-600 transition flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                                </svg>
                                Save Sample
                            </button>
                            <button id="btn-lip" type="button" class="px-4 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700">Run Lip Decoder</button>
                        </div>
                        <div id="lip-result" class="mt-3 text-sm text-gray-700 hidden"></div>
                    </div>
                </div>

                <!-- Captured Skeleton Visualization -->
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                    <div class="p-4 border-b border-gray-100">
                        <h2 class="text-lg font-semibold">Captured Skeleton Data</h2>
                    </div>
                    <div class="p-4">
                        <canvas id="skeleton-canvas" class="w-full h-64 bg-gray-900 rounded-xl"></canvas>
                        <div class="mt-4 flex items-center gap-4">
                            <input type="range" id="frame-slider" min="0" max="0" value="0" class="flex-1" disabled>
                            <span class="text-sm text-gray-600 font-mono w-16">
                                <span id="current-frame">0</span> / <span id="total-frames">0</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Sample Metadata -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">Sample Metadata</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Language</label>
                            <select id="language-select" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="ASL">American Sign Language (ASL)</option>
                                <option value="BdSL">Bangladeshi Sign Language (BdSL)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Transcript (English)</label>
                            <textarea id="transcript" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent resize-none" placeholder="Enter what the gesture means..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                            <input type="text" id="tags" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="greeting, question, ...">
                            <p class="text-xs text-gray-500 mt-1">Comma-separated tags</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Quality</label>
                            <select id="quality-select" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="unverified">Unverified</option>
                                <option value="verified">Verified</option>
                                <option value="expert">Expert Verified</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Capture Stats -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">Capture Statistics</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span class="text-gray-600">Frames Captured</span>
                            <span id="stat-frames" class="font-mono font-medium">0</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span class="text-gray-600">Duration</span>
                            <span id="stat-duration" class="font-mono font-medium">0.00s</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span class="text-gray-600">Frame Rate</span>
                            <span id="stat-fps" class="font-mono font-medium">30 fps</span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-gray-600">Joints Tracked</span>
                            <span class="font-mono font-medium">21 Ã— 2 hands</span>
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="bg-gradient-to-br from-primary/10 to-secondary/10 rounded-2xl p-6 border border-primary/20">
                    <h3 class="text-lg font-semibold mb-4 text-dark">Recording Tips</h3>
                    <ul class="space-y-2 text-sm text-gray-700">
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-secondary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Position hands within camera frame
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-secondary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Ensure good lighting conditions
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-secondary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Perform gesture at natural speed
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-secondary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Maximum 150 frames (~5 seconds)
                        </li>
                        <li class="flex items-start gap-2">
                            <svg class="w-5 h-5 text-secondary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Add accurate transcript after recording
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <!-- WebSocket & MediaPipe Integration Script -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script>
        // State
        let ws = null;
        let isRecording = false;
        let capturedFrames = [];
        let frameCount = 0;
        let hands = null;
        let camera = null;
        
        // DOM Elements
        const videoFeed = document.getElementById('video-feed');
        const skeletonOverlay = document.getElementById('skeleton-overlay');
        const skeletonCanvas = document.getElementById('skeleton-canvas');
        const recordingIndicator = document.getElementById('recording-indicator');
        const statusIndicator = document.getElementById('status-indicator');
        const frameCountEl = document.getElementById('frame-count');
        const frameSlider = document.getElementById('frame-slider');
        const currentFrameEl = document.getElementById('current-frame');
        const totalFramesEl = document.getElementById('total-frames');
        
        const btnConnect = document.getElementById('btn-connect');
        const btnRecord = document.getElementById('btn-record');
        const btnStop = document.getElementById('btn-stop');
        const btnSave = document.getElementById('btn-save');
        
        // Initialize MediaPipe Hands
        function initMediaPipe() {
            hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
            }});
            
            hands.setOptions({
                maxNumHands: 2,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
            
            hands.onResults(onHandResults);
        }
        
        // Handle hand detection results
        function onHandResults(results) {
            const ctx = skeletonOverlay.getContext('2d');
            skeletonOverlay.width = videoFeed.videoWidth || 640;
            skeletonOverlay.height = videoFeed.videoHeight || 480;
            
            ctx.clearRect(0, 0, skeletonOverlay.width, skeletonOverlay.height);
            
            if (results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    // Draw connections
                    drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color: '#10b981', lineWidth: 2});
                    // Draw landmarks
                    drawLandmarks(ctx, landmarks, {color: '#6366f1', lineWidth: 1, radius: 4});
                }
                
                // If recording, capture frame data
                if (isRecording && frameCount < 150) {
                    const frameData = {
                        timestamp: Date.now(),
                        hands: results.multiHandLandmarks.map((landmarks, idx) => ({
                            handedness: results.multiHandedness[idx]?.label || 'Unknown',
                            landmarks: landmarks.map(lm => ({
                                x: lm.x,
                                y: lm.y,
                                z: lm.z
                            }))
                        })),
                        face: latestFaceLandmarks ? latestFaceLandmarks.map(lm => ({ x: lm.x, y: lm.y, z: lm.z })) : []
                    };
                    
                    capturedFrames.push(frameData);
                    frameCount++;
                    frameCountEl.textContent = frameCount;
                    
                    // Send to WebSocket
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'frame',
                            data: frameData
                        }));
                    }
                    
                    // Auto-stop at max frames
                    if (frameCount >= 150) {
                        stopRecording();
                    }
                }
            }
        }
        
        // Connect camera
        btnConnect.addEventListener('click', async () => {
            try {
                initMediaPipe();
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480, facingMode: 'user' }
                });
                
                videoFeed.srcObject = stream;
                
                camera = new Camera(videoFeed, {
                    onFrame: async () => {
                        await hands.send({image: videoFeed});
                    },
                    width: 640,
                    height: 480
                });
                camera.start();
                
                // Connect WebSocket
                connectWebSocket();
                
                btnConnect.disabled = true;
                btnConnect.classList.add('opacity-50');
                btnRecord.disabled = false;
                
                updateStatus('connected', 'Connected');
            } catch (error) {
                console.error('Camera error:', error);
                alert('Failed to access camera. Please ensure camera permissions are granted.');
            }
        });
        
        // Connect WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/gesture/capture/`);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateStatus('disconnected', 'Disconnected');
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WS message:', data);
            };
        }
        
        // Update status indicator
        function updateStatus(status, text) {
            const indicator = statusIndicator.querySelector('span:first-child');
            const label = statusIndicator.querySelector('span:last-child');
            
            indicator.className = 'w-2 h-2 rounded-full mr-2';
            
            switch (status) {
                case 'connected':
                    indicator.classList.add('bg-green-500');
                    break;
                case 'recording':
                    indicator.classList.add('bg-red-500', 'animate-pulse');
                    break;
                default:
                    indicator.classList.add('bg-gray-400');
            }
            
            label.textContent = text;
        }
        
        // Start recording
        btnRecord.addEventListener('click', () => {
            isRecording = true;
            capturedFrames = [];
            frameCount = 0;
            
            recordingIndicator.classList.remove('hidden');
            btnRecord.disabled = true;
            btnStop.disabled = false;
            btnSave.disabled = true;
            
            updateStatus('recording', 'Recording');
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'start_recording' }));
            }
        });
        
        // Stop recording
        function stopRecording() {
            isRecording = false;
            
            recordingIndicator.classList.add('hidden');
            btnRecord.disabled = false;
            btnStop.disabled = true;
            btnSave.disabled = capturedFrames.length === 0;
            
            updateStatus('connected', 'Connected');
            
            // Update slider
            frameSlider.max = capturedFrames.length - 1;
            frameSlider.disabled = capturedFrames.length === 0;
            totalFramesEl.textContent = capturedFrames.length;
            
            // Update stats
            document.getElementById('stat-frames').textContent = capturedFrames.length;
            document.getElementById('stat-duration').textContent = (capturedFrames.length / 30).toFixed(2) + 's';
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'stop_recording' }));
            }
            
            // Draw first frame
            if (capturedFrames.length > 0) {
                drawSkeletonFrame(0);
            }
        }
        
        btnStop.addEventListener('click', stopRecording);
        
        // Frame slider
        frameSlider.addEventListener('input', (e) => {
            const frameIdx = parseInt(e.target.value);
            currentFrameEl.textContent = frameIdx;
            drawSkeletonFrame(frameIdx);
        });
        
        // Draw skeleton frame on canvas
        function drawSkeletonFrame(frameIdx) {
            const ctx = skeletonCanvas.getContext('2d');
            const frame = capturedFrames[frameIdx];
            
            if (!frame) return;
            
            ctx.fillStyle = '#111827';
            ctx.fillRect(0, 0, skeletonCanvas.width, skeletonCanvas.height);
            
            const scale = Math.min(skeletonCanvas.width, skeletonCanvas.height);
            const offsetX = (skeletonCanvas.width - scale) / 2;
            const offsetY = (skeletonCanvas.height - scale) / 2;
            
            for (const hand of frame.hands) {
                // Draw connections
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 2;
                
                const connections = [
                    [0, 1], [1, 2], [2, 3], [3, 4],      // Thumb
                    [0, 5], [5, 6], [6, 7], [7, 8],      // Index
                    [0, 9], [9, 10], [10, 11], [11, 12], // Middle
                    [0, 13], [13, 14], [14, 15], [15, 16], // Ring
                    [0, 17], [17, 18], [18, 19], [19, 20], // Pinky
                    [5, 9], [9, 13], [13, 17]             // Palm
                ];
                
                for (const [i, j] of connections) {
                    const p1 = hand.landmarks[i];
                    const p2 = hand.landmarks[j];
                    ctx.beginPath();
                    ctx.moveTo(offsetX + p1.x * scale, offsetY + p1.y * scale);
                    ctx.lineTo(offsetX + p2.x * scale, offsetY + p2.y * scale);
                    ctx.stroke();
                }
                
                // Draw joints
                for (const lm of hand.landmarks) {
                    ctx.fillStyle = '#6366f1';
                    ctx.beginPath();
                    ctx.arc(offsetX + lm.x * scale, offsetY + lm.y * scale, 4, 0, 2 * Math.PI);
                    ctx.fill();
                }
            }
            
            // Draw frame info
            ctx.fillStyle = '#ffffff';
            ctx.font = '14px JetBrains Mono';
            ctx.fillText(`Frame ${frameIdx + 1}/${capturedFrames.length}`, 10, 20);
        }
        
        // Save sample
        btnSave.addEventListener('click', async () => {
            const language = document.getElementById('language-select').value;
            const transcript = document.getElementById('transcript').value;
            const tags = document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t);
            const quality = document.getElementById('quality-select').value;

            if (!transcript) {
                alert('Please enter a transcript for this gesture.');
                return;
            }

            const sampleData = {
                language: language,
                transcript: transcript,
                tags: tags,
                quality: quality,
                frames: capturedFrames,
                metadata: {
                    recorded_at: new Date().toISOString(),
                    frame_count: capturedFrames.length,
                    fps: 30
                }
            };

            // CSRF helper
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrfToken = getCookie('csrftoken');

            try {
                const response = await fetch('/gestures/save/', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(sampleData)
                });

                if (response.ok) {
                    alert('Sample saved successfully!');
                    // Reset
                    capturedFrames = [];
                    frameCount = 0;
                    frameCountEl.textContent = '0';
                    document.getElementById('transcript').value = '';
                    document.getElementById('tags').value = '';
                    btnSave.disabled = true;
                } else {
                    const error = await response.json();
                    alert('Failed to save sample: ' + JSON.stringify(error));
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save sample. Check console for details.');
            }
        });
    </script>
</body>
</html>
